name: E2E Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
    # 1. Uygulama reposunu checkout et
    - name: Checkout Application Code
      uses: actions/checkout@v4
      with:
        path: app

    # 2. Node.js kurulumunu yap
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. Backend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± yÃ¼kle
    - name: Install Backend Dependencies
      run: |
        cd app/backend
        npm install

    # 4. Newman'Ä± kÃ¼resel olarak yÃ¼kle
    - name: Install Newman
      run: npm install -g newman

    # 5. Frontend iÃ§in serve paketini kÃ¼resel olarak yÃ¼kle
    - name: Install Serve Package
      run: npm install -g serve

    # 6. Frontend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± yÃ¼kle
    - name: Install Frontend Dependencies
      run: |
        cd app/frontend
        npm install

    # 7. Backend sunucusunu arka planda baÅŸlat
    - name: Start Backend Server
      run: |
        cd app/backend
        npm start &
        echo $! > backend.pid
        sleep 10
        curl -f http://localhost:3001 || echo "Backend started"

    # 8. Frontend'i inÅŸa et ve baÅŸlat
    - name: Build and Start Frontend
      run: |
        cd app/frontend
        CI=false npm run build
        npx serve -s build -l 3000 &
        echo $! > frontend.pid
        sleep 15
        curl -f http://localhost:3000 || echo "Frontend started"

    # 9. API Testlerini Newman ile Ã‡alÄ±ÅŸtÄ±r
    - name: Run API Tests with Newman
      run: |
        cd test/postman
        newman run postman_collection.json -e environment.json --reporters cli,html --reporter-html-export newman-report.html
        mv newman-report.html tests/reports/

    # 10. Newman Raporunu Artifact Olarak YÃ¼kle
    - name: Upload Newman Report
      uses: actions/upload-artifact@v4
      with:
        name: newman-report
        path: tests/reports/newman-report.html
        retention-days: 30

    # 11. Cucumber RaporlarÄ±nÄ± YÃ¼kle
    - name: Upload Cucumber HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: cucumber-html-report
        path: |
          tests/target/**/*cucumber*.html
          tests/target/**/*report*.html
        retention-days: 30

    # 12. PR'ye Test SonuÃ§larÄ±nÄ± Yorum Olarak Ekleyin
    - name: Comment Test Results on PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          
          let reportComment = '# ğŸ§ª API Test Results\n\n';
          
          // Newman rapor baÄŸlantÄ±sÄ±nÄ± ekleyin
          const reportUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';
          reportComment += `**ğŸ”— [View Test Report](tests/reports/newman-report.html)**\n\n`;
          reportComment += '## ğŸ“Š Test Reports\n';
          reportComment += '| ğŸ“ Artifact | ğŸ“ Description |\n';
          reportComment += '|-------------|----------------|\n';
          reportComment += '| ğŸ“‹ `newman-report` | HTML formatÄ±nda Newman raporu |\n';
          
          // Cucumber rapor baÄŸlantÄ±sÄ±nÄ± ekleyin
          const cucumberUrl = process.env.CUCUMBER_REPORT_URL;
          if (cucumberUrl && cucumberUrl !== 'NOT_FOUND' && cucumberUrl !== '') {
            reportComment += '## ğŸ¥’ Live Cucumber Report\n';
            reportComment += `**ğŸ”— [View Interactive Cucumber Report](${cucumberUrl})**\n\n`;
            reportComment += '> ğŸ“‹ Bu rapor canlÄ± olup, test sonuÃ§larÄ±nÄ± detaylÄ± ÅŸekilde inceleyebilirsiniz.\n\n';
          } else {
            reportComment += '## âš ï¸ Cucumber Report\n';
            reportComment += 'Online Cucumber report URL bulunamadÄ±. LÃ¼tfen artifacts\'taki loglarÄ± kontrol edin.\n\n';
          }
          
          reportComment += '## ğŸ“Š Available Reports\n\n';
          reportComment += '| ğŸ“ Artifact | ğŸ“ Description |\n';
          reportComment += '|-------------|----------------|\n';
          reportComment += '| ğŸ“‹ `newman-report` | HTML formatÄ±nda Newman raporu |\n';
          reportComment += '| ğŸ¥’ `cucumber-html-report` | HTML formatÄ±nda Cucumber raporlarÄ± |\n';
          reportComment += '| ğŸ“Š `comprehensive-test-reports` | TÃ¼m test dosyalarÄ± (JSON, XML, HTML) |\n';
          reportComment += '| ğŸ“¸ `test-screenshots` | Hata durumunda ekran gÃ¶rÃ¼ntÃ¼leri |\n\n';
          
          reportComment += '**ğŸ’¡ Ä°pucu:** YukarÄ±daki "Artifacts" bÃ¶lÃ¼mÃ¼nden istediÄŸiniz raporu indirebilirsiniz.\n\n';
          reportComment += `**ğŸ”— [View Full Workflow Run](${context.payload.pull_request.html_url}/checks)`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reportComment
          });
